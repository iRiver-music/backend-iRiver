# /login/
# base 函式：處理用戶登入的基本操作
def get_uuid():
    uid=uuid.uuid4()
    uid_str=str(uid).replace('-','')
    short_uid="a" + uid_str[:12]
    return short_uid

def base(userid,email,name,imageurl,request):
    row=query(dbconfiguser,"SELECT`userid`FROM `user_social`WHERE`userid`=%s",(userid))
    rowemail=query(dbconfiguser,"SELECT`uid`FROM `user_social`WHERE`email`=%s",(email))

    # sql=sqllogin(DB_CONFIG_user)
    # sql_user=sqluser(DB_CONFIG_user)

    # 檢查是否有帳號
    if row==None:
        if rowemail==None:
            uid=None
        else:
            uid=rowemail[0]

        if uid is None:
            uid=get_uuid()

        if not row:
            uid=query(dbconfiguser,"INSERT INTO `user_social`(`userid`,`email`,`uid`)VALUES(%s,%s,%s)",(userid,email,uid))
        saveuserprofile(uid,email,name)
        # return uid
        # uid=sql.insert(userid,email)

        # 創建用戶音樂列表表格（如果不存在）
        sqlmusic(config=DB_CONFIG_user_music_list,table_name=uid).createusertable()

        # 註冊用戶均衡器
        sqleq(config=DB_CONFIG_user).register(UID_EQ=uid)

        # 註冊用戶設置
        sqlusersetting(config=DB_CONFIG_user).register(UID_SETTING=uid)
    else:
        uid=query(dbconfiguser,"INSERT INTO `user_social`(`userid`,`email`,`uid`)VALUES(%s,%s,%s)",(userid,email,uid))

    # sql.close()

    # 保存用戶會話數據
    request.session['key'] = uid  # 保存會話鍵
    request.session['name'] = name  # 保存用戶名
    request.session['email'] = email  # 保存郵件地址
    request.session['UID'] = uid  # 保存用戶 ID
    request.session['user_img_url'] = imageurl  # 保存用戶頭像 URL

    # 創建 SQL 使用者實例
    sql_user = sqluser(DB_CONFIG_user)

    # 舊版
    request.session['user_data'] = {'name': kwargs.get('name')}  # 保存用戶數據

    # 創建 SQL 音樂實例
    sql_user_music_list = sqlmusic(config=DB_CONFIG_user_music_list, table_name=uid)

    # 創建用戶音樂列表表格（如果不存在）
    sql_user_music_list.create_tables()

    # 獲取用戶播放列表
    user_playlist = sql_user_music_list.get_playlists(isAll=True)

    request.session['user_playlist'] = user_playlist  # 保存用戶播放列表

    # eq
    user_eq = sqleq(DB_CONFIG_user).commit(method="select", UID_EQ=uid)

    request.session['user_eq'] = user_eq  # 保存用戶均衡器設置

    # setting
    user_setting = sqlusersetting(DB_CONFIG_user).commit(method="select", UID_SETTING=uid)

    request.session['user_setting'] = user_setting  # 保存用戶設置

    request.session.save()

    print("##############################")
    print_color("save session "+str(request.session['user_data'])+str(request.session['user_playlist']),"warning")
    return JsonResponse({"success": True})

# google
# google_url 函式：生成 Google 登入連結
def google_url(request):
    state=str(uuid.uuid4())
    request.session['oauth_state']=state
    auth_url=f'https://accounts.google.com/o/oauth2/v2/auth?scope={scope}&access_type={access_type}&include_granted_scopes={include_granted_scopes}&response_type={response_type}&state={state}&redirect_uri={urlgoogle}&client_id={client_id}'
    return auth_url

# google_token 函式：獲取存取令牌
def google_token(code):
    url='https://oauth2.googleapis.com/token'
    params={
        'code': code,
        'client_id': client_id,
        'client_secret': client_secret,
        'redirect_uri': urlgoogle,
        'grant_type': 'authorization_code'
    }
    response=requests.post(url,data=params)
    token_data=response.json()
    id_token=token_data.get('id_token',None)
    access_token=token_data.get('access_token',None)
    return {'id_token': id_token,'access_token': access_token}

# google_profile 函式：獲取使用者資料
def google_profile(id_token):
    url='https://oauth2.googleapis.com/tokeninfo'
    data={
        'id_token': id_token,
    }
    response=requests.get(url,params=data)
    data=response.json()
    email=data['email']
    picture=data['picture']
    userid=data['sub']
    name=data['name']
    return {'email': email,'picture': picture,'userid': userid,'name': name}

# google_callback 函式：處理 Google 登入回調
def google_callback(request):
    code=request.GET.get('code')
    state=request.GET.get('state')
    if code and state == request.session.get('oauth_state'):
        token_data=google_token(code)
        id_token=token_data['id_token']
        access_token=token_data['access_token']
        userdata=google_profile(id_token)
        base(
            userid=userdata['userid'],
            email=userdata['email'],
            name=userdata['name'],
            user_img_url=userdata['picture'],
            request=request)
        return True
    print("驗證失敗")
    return False

# line
# line_url 函式：生成 Line 登入連結
def line_url(request):
    state=str(uuid.uuid4())
    request.session['oauth_state']=state
    encoded_scopes=urllib.parse.quote(" ".join(scopes))
    auth_url=f'https://access.line.me/oauth2/v2.1/authorize?response_type={response_type}&client_id={client_id}&redirect_uri={urlline}&state={state}&scope={encoded_scopes}'
    return auth_url

# line_token 函式：獲取存取令牌
def line_token(code):
    url='https://api.line.me/oauth2/v2.1/token'
    data={
        'grant_type': 'authorization_code',
        'code': code,
        'redirect_uri': urlline,
        'client_id': client_id,
        'client_secret': client_secret,
    }
    response=requests.post(url,data)
    token_data=response.json()
    id_token=token_data.get('id_token',None)
    access_token=token_data.get('access_token',None)
    return {'id_token': id_token,'access_token': access_token}

# line_profile 函式：獲取用戶資料
def line_profile(id_token,client_id):
    url='https://api.line.me/oauth2/v2.1/verify'
    data={
        'id_token': id_token,
        'client_id': client_id,
    }
    response=requests.post(url,data=data)
    data=response.json()
    email=data['email']
    picture=data['picture']
    userid=data['sub']
    name=data['name']
    return {'email': email,'picture': picture,'userid': userid,'name': name}

# line_callback 函式：處理 Line 登入回調
def line_callback(request):
    code=request.GET.get('code')
    state=request.GET.get('state')
    if code and state == request.session.get('oauth_state'):
        token_data=line_token(code)
        id_token=token_data['id_token']
        access_token=token_data['access_token']
        userdata=line_profile(id_token,client_id)
        name=userdata['name']
        email=userdata['email']
        picture=userdata['picture']
        userid=userdata['userid']
        base(name=name,email=email,user_img_url=picture,userid=userid,request=request)
        return True
    print("驗證失敗")
    return False



def createusertable():
    sql='''
        CREATE TABLE IF NOT EXISTS user_profile (
            id VARCHAR(36) NOT NULL PRIMARY KEY,
            email VARCHAR(24) NOT NULL,
            username VARCHAR(24) NOT NULL,
            phone VARCHAR(16) NOT NULL,
            country CHAR(2),
            birthday DATE,
            gender CHAR(1),
            user_img_url VARCHAR(255),
            test TINYINT(2) UNSIGNED DEFAULT 0,
            level TINYINT(2) UNSIGNED DEFAULT 0
        )
    '''
    query(dbconfiguser,sql)


# 儲存用戶個人資料
def saveuserprofile(id="",email="",username="",phone="",country="",birthday="",gender="",imageurl="",test=0,level=0):
    print("******************************")
    print(id)
    query(dbconfiguser,'INSERT `IGNORE` INTO `user_profile` (`id`,`email`,`username`,`phone`,`country`,`birthday`,`gender`,`user_img_url`,`test`,`level`)VALUES(%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)',(id,email,username,phone,country,birthday,gender,imageurl,test,level))
    query(dbconfiguser,'UPDATE `user_profile` SET `email`=%s,`username`=%s,`phone`=%s,`country`=%s,`birthday`=%s,`gender`=%s,`user_img_url`=%s,`test`=%s,`level`=%s WHERE `id`=%s',(email,username,phone,country,birthday,gender,imageurl,test,level,id))


def get_user_data(uid):
    # 查詢指定使用者資料
    result=query(dbconfiguser,'SELECT * FROM user_profile WHERE id=%s',(uid))
    if result:
        data={
            'id': result[0][0],
            'email': result[0][1],
            'username': result[0][2],
            'phone': result[0][3],
            'country': result[0][4],
            'birthday': result[0][5],
            'gender': result[0][6],
            'user_img_url': result[0][7],
            'test': result[0][8],
            'level': result[0][9],
        }
        print("$" * 30)
        print(data)
        return data
    else:
        return None


def get_user_show_data(uid):
    # 查詢指定使用者的展示資料
    result=query(dbconfiguser,'SELECT * FROM user_profile WHERE id=%s',(uid))
    if result:
        data={
            'id': result[0][0],
            'email': result[0][1],
            'username': result[0][2],
            'level': result[0][7],
        }
        print("$" * 30)
        print(data)
        return data
    else:
        return None








###################################################








def create_tables():
    sql = '''
        CREATE TABLE IF NOT EXISTS user_profile (
            id VARCHAR(36) NOT NULL PRIMARY KEY,
            email VARCHAR(24) NOT NULL,
            username VARCHAR(24) NOT NULL,
            phone VARCHAR(16) NOT NULL,
            country CHAR(2),
            birthday DATE,
            gender CHAR(1),
            user_img_url VARCHAR(255),
            test TINYINT(2) UNSIGNED DEFAULT 0,
            level TINYINT(2) UNSIGNED DEFAULT 0
        )
    '''
    query(dbuser, sql)


def save_user_profile(**user_profile):
    print("*" * 30)
    print(user_profile)
    id = user_profile.get('id')
    email = user_profile.get('email')
    username = user_profile.get('username')
    phone = user_profile.get('phone')
    country = user_profile.get('country')
    birthday = user_profile.get('birthday')
    gender = user_profile.get('gender')
    user_img_url = user_profile.get('user_img_url')
    test = user_profile.get('test', 0)
    level = user_profile.get('level', 0)
    query(dbuser, 'INSERT `IGNORE` INTO `user_profile` (`id`,`email`,`username`,`phone`,`country`,`birthday`,`gender`,`user_img_url`,`test`,`level`) VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)', (id, email, username, phone, country, birthday, gender, user_img_url, test, level))
    query(dbuser, 'UPDATE user_profile SET email=%s,username=%s,phone=%s,country=%s,bir`thday=%s,gender=%s,user_img_url=%s,test=%s,level=%s WHERE id=%s', (email, username, phone, country, birthday, gender, user_img_url, test, level, id))


def get_user_data(uid):
    result = query(dbuser, 'SELECT * FROM user_profile WHERE id=%s', (uid,))
    if result:
        data = {
            'id': result[0][0],
            'email': result[0][1],
            'username': result[0][2],
            'phone': result[0][3],
            'country': result[0][4],
            'birthday': result[0][5],
            'gender': result[0][6],
            'user_img_url': result[0][7],
            'test': result[0][8],
            'level': result[0][9],
        }
        print("$" * 30)
        print(data)
        return data
    else:
        return None


def get_user_show_data(uid):
    result = query(dbuser, 'SELECT * FROM user_profile WHERE id=%s', (uid,))
    if result:
        data = {
            'id': result[0][0],
            'email': result[0][1],
            'username': result[0][2],
            'level': result[0][7],
        }
        print("$" * 30)
        print(data)
        return data
    else:
        return None


def close():
    dbuser.close()

